<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #00b09b 0%, #96c93d 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table th {
            background: #4b6cb7;
            color: white;
            border: none;
            padding: 15px;
        }
        
        .table td {
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(75, 108, 183, 0.05);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready {
            background-color: #28a745;
        }
        
        .status-loading {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-section {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .badge-category {
            background: linear-gradient(90deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h1 class="mb-0"><i class="fas fa-basketball-ball me-2"></i>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ</h1>
                        <p class="mb-0 mt-2">å®æ—¶çˆ¬å–å¹¶å±•ç¤ºNBAçƒå‘˜å¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»æ•°æ®</p>
                    </div>
                    
                    <div class="card-body">
                        <!-- æ§åˆ¶é¢æ¿ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-cloud-download-alt me-2"></i>æ•°æ®çˆ¬å–æ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®å¼€å§‹çˆ¬å–æœ€æ–°çš„NBAæ•°æ®ï¼ˆå¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»ï¼‰</p>
                                        <button id="extractBtn" class="btn btn-primary btn-lg">
                                            <i class="fas fa-play me-2"></i>å¼€å§‹çˆ¬å–æ•°æ®
                                        </button>
                                        <div class="mt-3">
                                            <span class="status-indicator status-ready" id="statusIndicator"></span>
                                            <span id="statusText">å°±ç»ª</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-table me-2"></i>æ•°æ®å±•ç¤ºæ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹å·²çˆ¬å–çš„NBAæ•°æ®</p>
                                        <button id="showBtn" class="btn btn-success btn-lg">
                                            <i class="fas fa-eye me-2"></i>æŸ¥çœ‹æ•°æ®
                                        </button>
                                        <div class="mt-3">
                                            <small class="text-muted">æ•°æ®å°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <i class="fas fa-download me-2"></i>æ•°æ®å¯¼å‡ºæ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®ä¸‹è½½Excelæ•°æ®æ–‡ä»¶</p>
                                        <button id="exportBtn" class="btn btn-warning btn-lg">
                                            <i class="fas fa-file-excel me-2"></i>å¯¼å‡ºExcel
                                        </button>
                                        <div class="mt-3">
                                            <small class="text-muted">ä¸‹è½½æœ€æ–°çš„NBA.xlsxæ–‡ä»¶</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-3" id="loadingText">æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·ç¨å€™...</p>
                        </div>
                        
                        <!-- æ¶ˆæ¯æç¤º -->
                        <div id="messageArea"></div>
                        
                        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-database me-2"></i>NBAæ•°æ®å±•ç¤º
                                <span class="badge bg-light text-dark ms-2" id="dataCount">0 æ¡æ•°æ®</span>
                            </div>
                            <div class="card-body">
                                <div class="data-section">
                                    <table class="table table-striped table-hover" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>æ•°æ®ç±»å‹</th>
                                                <th>æ’å</th>
                                                <th>çƒå‘˜å§“å</th>
                                                <th>æ•°æ®å€¼</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                            <tr id="noDataRow">
                                                <td colspan="6" class="text-center text-muted py-5">
                                                    <i class="fas fa-database fa-3x mb-3"></i>
                                                    <p>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»"å¼€å§‹çˆ¬å–æ•°æ®"æŒ‰é’®è·å–æ•°æ®</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç³»ç»Ÿä¿¡æ¯ -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-server fa-2x text-primary mb-3"></i>
                                        <h5>åç«¯çŠ¶æ€</h5>
                                        <p class="mb-0" id="backendStatus">æ­£åœ¨æ£€æŸ¥...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-history fa-2x text-success mb-3"></i>
                                        <h5>æœ€åæ›´æ–°</h5>
                                        <p class="mb-0" id="lastUpdate">ä»æœªæ›´æ–°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-info-circle fa-2x text-info mb-3"></i>
                                        <h5>æ•°æ®æ¥æº</h5>
                                        <p class="mb-0">ç™¾åº¦ä½“è‚²NBAæ—¥æ¦œ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    <p>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ &copy; 2025 | åŸºäºFlask + BeautifulSoupæ„å»º</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- è‡ªå®šä¹‰JavaScript -->
    <script>
        // DOMå…ƒç´ 
        const extractBtn = document.getElementById('extractBtn');
        const showBtn = document.getElementById('showBtn');
        const exportBtn = document.getElementById('exportBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        const messageArea = document.getElementById('messageArea');
        const dataTableBody = document.getElementById('dataTableBody');
        const noDataRow = document.getElementById('noDataRow');
        const dataCount = document.getElementById('dataCount');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const backendStatus = document.getElementById('backendStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        
        // APIç«¯ç‚¹
        const API_BASE = window.location.origin;
        const EXTRACT_API = `${API_BASE}/extract_data`;
        const SHOW_API = `${API_BASE}/show_data`;
        const EXPORT_API = `${API_BASE}/download_excel`;
        
        // çŠ¶æ€ç®¡ç†
        let isProcessing = false;
        let lastUpdateTime = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendStatus();
            updateLastUpdateTime();
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬
            extractBtn.addEventListener('click', extractData);
            showBtn.addEventListener('click', showData);
            exportBtn.addEventListener('click', exportData);
        });
        
        // æ£€æŸ¥åç«¯çŠ¶æ€
        async function checkBackendStatus() {
            try {
                const response = await fetch(SHOW_API, { method: 'HEAD' });
                if (response.ok) {
                    backendStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>è¿è¡Œæ­£å¸¸</span>';
                } else {
                    backendStatus.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>è¿æ¥å¼‚å¸¸</span>';
                }
            } catch (error) {
                backendStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>æ— æ³•è¿æ¥</span>';
            }
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            if (lastUpdateTime) {
                const timeStr = new Date(lastUpdateTime).toLocaleString('zh-CN');
                lastUpdate.textContent = timeStr;
            } else {
                lastUpdate.textContent = 'ä»æœªæ›´æ–°';
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(type, text) {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            const messageHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${icon} me-2"></i>${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            messageArea.innerHTML = messageHtml;
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        if (alert.parentNode === messageArea) {
                            messageArea.removeChild(alert);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(isLoading, text = 'æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·ç¨å€™...') {
            isProcessing = isLoading;
            
            if (isLoading) {
                loadingSpinner.style.display = 'block';
                loadingText.textContent = text;
                extractBtn.disabled = true;
                showBtn.disabled = true;
                statusIndicator.className = 'status-indicator status-loading';
                statusText.textContent = 'å¤„ç†ä¸­...';
            } else {
                loadingSpinner.style.display = 'none';
                extractBtn.disabled = false;
                showBtn.disabled = false;
                statusIndicator.className = 'status-indicator status-ready';
                statusText.textContent = 'å°±ç»ª';
            }
        }
        
        // æå–æ•°æ®
        async function extractData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨çˆ¬å–NBAæ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...');
            
            try {
                const response = await fetch(EXTRACT_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', 'æ•°æ®çˆ¬å–æˆåŠŸï¼æ•°æ®å·²ä¿å­˜åˆ°Excelæ–‡ä»¶ã€‚æ­£åœ¨è‡ªåŠ¨åŠ è½½æ•°æ®...');
                    lastUpdateTime = new Date();
                    updateLastUpdateTime();
                    
                    // çˆ¬å–æˆåŠŸåè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®
                    setTimeout(() => {
                        showData();
                    }, 1000);
                } else {
                    showMessage('error', `æ•°æ®çˆ¬å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æå–æ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
                checkBackendStatus();
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®
        async function showData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨åŠ è½½NBAæ•°æ®...');
            
            try {
                const response = await fetch(SHOW_API);
                const data = await response.json();
                
                if (response.ok) {
                    displayData(data.NBA_datas || []);
                    showMessage('success', `æˆåŠŸåŠ è½½ ${data.NBA_datas ? data.NBA_datas.length : 0} æ¡æ•°æ®`);
                } else {
                    showMessage('error', `åŠ è½½æ•°æ®å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºæ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨å‡†å¤‡Excelæ–‡ä»¶ä¸‹è½½...');
            
            try {
                // åˆ›å»ºä¸€ä¸ªéšè—çš„é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶
                const link = document.createElement('a');
                link.href = `${API_BASE}/static/NBA.xlsx`;
                link.download = `NBAæ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`;
                link.target = '_blank';
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('success', 'Excelæ–‡ä»¶ä¸‹è½½å·²å¼€å§‹');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `å¯¼å‡ºå¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®åˆ°è¡¨æ ¼
        function displayData(data) {
            // æ¸…é™¤ç°æœ‰æ•°æ®
            dataTableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                dataTableBody.innerHTML = `
                    <tr id="noDataRow">
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="fas fa-database fa-3x mb-3"></i>
                            <p>æš‚æ— æ•°æ®</p>
                        </td>
                    </tr>
                `;
                dataCount.textContent = '0 æ¡æ•°æ®';
                return;
            }
            
            // ç§»é™¤æ— æ•°æ®è¡Œ
            if (noDataRow) {
                noDataRow.remove();
            }
            
            let rowCount = 0;
            
            // å¤„ç†æ•°æ®è¡Œ
            data.forEach((row, rowIndex) => {
                // è·³è¿‡è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰
                if (rowIndex === 0) return;
                
                // å¤„ç†æ¯ä¸€è¡Œçš„æ•°æ®
                // æ•°æ®æ ¼å¼: [ç±»å‹, æ’å, å§“å, æ•°æ®, ç©º, ç±»å‹, æ’å, å§“å, æ•°æ®, ç©º, ç±»å‹, æ’å, å§“å, æ•°æ®]
                // æ¯è¡ŒåŒ…å«3ç»„æ•°æ®ï¼ˆå¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»ï¼‰
                
                // åˆ›å»ºä¸‰è¡Œæ•°æ®ï¼Œæ¯ç»„æ•°æ®ä¸€è¡Œ
                for (let groupIndex = 0; groupIndex < 3; groupIndex++) {
                    const dataStart = groupIndex * 5; // æ¯ç»„æ•°æ®å 5åˆ—ï¼ˆç±»å‹,æ’å,å§“å,æ•°æ®,ç©ºï¼‰
                    const dataType = row[dataStart];
                    const rank = row[dataStart + 1];
                    const name = row[dataStart + 2];
                    const value = row[dataStart + 3];
                    
                    // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡
                    if (!dataType || !rank || !name || !value) continue;
                    
                    rowCount++;
                    
                    // æ ¹æ®æ•°æ®ç±»å‹è®¾ç½®æ ·å¼
                    let badgeClass = 'badge-category';
                    let dataTypeText = dataType;
                    
                    if (dataType === 'å¾—åˆ†') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#e74c3c">ğŸ€ å¾—åˆ†</span>';
                    } else if (dataType === 'ç¯®æ¿') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#3498db">ğŸ“Š ç¯®æ¿</span>';
                    } else if (dataType === 'åŠ©æ”»') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#2ecc71">ğŸ¤ åŠ©æ”»</span>';
                    }
                    
                    // åˆ›å»ºè¡¨æ ¼è¡Œ
                    const rowHtml = `
                        <tr>
                            <td>${rowCount}</td>
                            <td>${dataTypeText}</td>
                            <td>
                                <span class="badge bg-primary rounded-pill">${rank}</span>
                            </td>
                            <td>
                                <strong>${name}</strong>
                            </td>
                            <td>
                                <span class="badge bg-success rounded-pill fs-6">${value}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewPlayerDetails('${name}', '${dataType}', '${value}')">
                                    <i class="fas fa-search"></i> è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    dataTableBody.innerHTML += rowHtml;
                }
            });
            
            // æ›´æ–°æ•°æ®è®¡æ•°
            dataCount.textContent = `${rowCount} æ¡æ•°æ®`;
        }
        
        // æŸ¥çœ‹çƒå‘˜è¯¦æƒ…
        function viewPlayerDetails(name, dataType, value) {
            alert(`çƒå‘˜è¯¦æƒ…:\n\nå§“å: ${name}\næ•°æ®ç±»å‹: ${dataType}\næ•°å€¼: ${value}`);
        }
        
        // æ£€æŸ¥åç«¯è¿æ¥
        checkBackendStatus();
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        updateLastUpdateTime();
    </script>
</body>
</html>