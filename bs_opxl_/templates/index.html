<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #00b09b 0%, #96c93d 100%);
            border: none;
            padding: 12px 30px;
            font-weight: bold;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table th {
            background: #4b6cb7;
            color: white;
            border: none;
            padding: 15px;
        }
        
        .table td {
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(75, 108, 183, 0.05);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready {
            background-color: #28a745;
        }
        
        .status-loading {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-section {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .badge-category {
            background: linear-gradient(90deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* æœ€é«˜çƒå‘˜å¡ç‰‡æ ·å¼ */
        .player-info {
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .player-info h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            min-height: 2.5rem;
            transition: transform 0.3s ease;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .highlight {
            animation: highlight 0.5s ease;
        }
        
        /* æœ€é«˜æ•°æ®å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .card.bg-light:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
        .btn-light {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn-light:hover {
            background-color: white;
            border-color: rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h1 class="mb-0"><i class="fas fa-basketball-ball me-2"></i>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ</h1>
                        <p class="mb-0 mt-2">å®æ—¶çˆ¬å–å¹¶å±•ç¤ºNBAçƒå‘˜å¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»æ•°æ®</p>
                    </div>
                    
                    <div class="card-body">
                        <!-- æ§åˆ¶é¢æ¿ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-cloud-download-alt me-2"></i>æ•°æ®çˆ¬å–æ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®å¼€å§‹çˆ¬å–æœ€æ–°çš„NBAæ•°æ®ï¼ˆå¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»ï¼‰</p>
                                        <button id="extractBtn" class="btn btn-primary btn-lg">
                                            <i class="fas fa-play me-2"></i>å¼€å§‹çˆ¬å–æ•°æ®
                                        </button>
                                        <div class="mt-3">
                                            <span class="status-indicator status-ready" id="statusIndicator"></span>
                                            <span id="statusText">å°±ç»ª</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-table me-2"></i>æ•°æ®å±•ç¤ºæ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹å·²çˆ¬å–çš„NBAæ•°æ®</p>
                                        <button id="showBtn" class="btn btn-success btn-lg">
                                            <i class="fas fa-eye me-2"></i>æŸ¥çœ‹æ•°æ®
                                        </button>
                                        <div class="mt-3">
                                            <small class="text-muted">æ•°æ®å°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <i class="fas fa-download me-2"></i>æ•°æ®å¯¼å‡ºæ§åˆ¶
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text">ç‚¹å‡»æŒ‰é’®ä¸‹è½½Excelæ•°æ®æ–‡ä»¶</p>
                                        <button id="exportBtn" class="btn btn-warning btn-lg">
                                            <i class="fas fa-file-excel me-2"></i>å¯¼å‡ºExcel
                                        </button>
                                        <div class="mt-3">
                                            <small class="text-muted">ä¸‹è½½æœ€æ–°çš„NBA.xlsxæ–‡ä»¶</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-3" id="loadingText">æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·ç¨å€™...</p>
                        </div>
                        
                        <!-- æ¶ˆæ¯æç¤º -->
                        <div id="messageArea"></div>
                        
                        <!-- å½“å¤©æœ€é«˜æ•°æ®å±•ç¤º -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-danger text-white">
                                        <i class="fas fa-trophy me-2"></i>ä»Šæ—¥æ•°æ®ä¹‹ç‹
                                        <button id="refreshTopBtn" class="btn btn-sm btn-light float-end">
                                            <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center" id="topPlayersSection">
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <i class="fas fa-basketball-ball fa-3x text-danger mb-3"></i>
                                                        <h5>å¾—åˆ†ç‹</h5>
                                                        <div class="player-info">
                                                            <h3 id="topScorerName" class="text-danger">--</h3>
                                                            <p class="mb-0">
                                                                <span class="badge bg-danger fs-5" id="topScorerScore">0</span> åˆ†
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                                        <h5>ç¯®æ¿ç‹</h5>
                                                        <div class="player-info">
                                                            <h3 id="topRebounderName" class="text-primary">--</h3>
                                                            <p class="mb-0">
                                                                <span class="badge bg-primary fs-5" id="topRebounderRebounds">0</span> ä¸ª
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <i class="fas fa-hands-helping fa-3x text-success mb-3"></i>
                                                        <h5>åŠ©æ”»ç‹</h5>
                                                        <div class="player-info">
                                                            <h3 id="topAssisterName" class="text-success">--</h3>
                                                            <p class="mb-0">
                                                                <span class="badge bg-success fs-5" id="topAssisterAssists">0</span> æ¬¡
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <small class="text-muted" id="topPlayersDate">æ•°æ®æ—¥æœŸ: --</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å®šæ—¶ä»»åŠ¡çŠ¶æ€é¢æ¿ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <i class="fas fa-clock me-2"></i>å®šæ—¶çˆ¬å–æœåŠ¡çŠ¶æ€
                                        <div class="float-end">
                                            <button id="triggerCrawlBtn" class="btn btn-sm btn-warning me-2">
                                                <i class="fas fa-play me-1"></i>ç«‹å³çˆ¬å–
                                            </button>
                                            <button id="refreshSchedulerBtn" class="btn btn-sm btn-light">
                                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°çŠ¶æ€
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5>æœåŠ¡çŠ¶æ€</h5>
                                                <div class="mb-3">
                                                    <span class="badge bg-success" id="schedulerStatus">è¿è¡Œä¸­</span>
                                                    <span class="ms-2" id="lastCrawlTime">æœ€åçˆ¬å–: --</span>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>å®šæ—¶ä»»åŠ¡</h6>
                                                    <ul class="list-group" id="schedulerJobs">
                                                        <li class="list-group-item">åŠ è½½ä¸­...</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>æ§åˆ¶é¢æ¿</h5>
                                                <div class="btn-group-vertical w-100" role="group">
                                                    <button class="btn btn-outline-success mb-2" id="startSchedulerBtn">
                                                        <i class="fas fa-play-circle me-2"></i>å¯åŠ¨å®šæ—¶æœåŠ¡
                                                    </button>
                                                    <button class="btn btn-outline-danger mb-2" id="stopSchedulerBtn">
                                                        <i class="fas fa-stop-circle me-2"></i>åœæ­¢å®šæ—¶æœåŠ¡
                                                    </button>
                                                    <button class="btn btn-outline-info" id="viewLogsBtn">
                                                        <i class="fas fa-file-alt me-2"></i>æŸ¥çœ‹æ—¥å¿—
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-database me-2"></i>NBAæ•°æ®å±•ç¤º
                                <span class="badge bg-light text-dark ms-2" id="dataCount">0 æ¡æ•°æ®</span>
                            </div>
                            <div class="card-body">
                                <div class="data-section">
                                    <table class="table table-striped table-hover" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>æ•°æ®ç±»å‹</th>
                                                <th>æ’å</th>
                                                <th>çƒå‘˜å§“å</th>
                                                <th>æ•°æ®å€¼</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                            <tr id="noDataRow">
                                                <td colspan="6" class="text-center text-muted py-5">
                                                    <i class="fas fa-database fa-3x mb-3"></i>
                                                    <p>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»"å¼€å§‹çˆ¬å–æ•°æ®"æŒ‰é’®è·å–æ•°æ®</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç³»ç»Ÿä¿¡æ¯ -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-server fa-2x text-primary mb-3"></i>
                                        <h5>åç«¯çŠ¶æ€</h5>
                                        <p class="mb-0" id="backendStatus">æ­£åœ¨æ£€æŸ¥...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-history fa-2x text-success mb-3"></i>
                                        <h5>æœ€åæ›´æ–°</h5>
                                        <p class="mb-0" id="lastUpdate">ä»æœªæ›´æ–°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-info-circle fa-2x text-info mb-3"></i>
                                        <h5>æ•°æ®æ¥æº</h5>
                                        <p class="mb-0">ç™¾åº¦ä½“è‚²NBAæ—¥æ¦œ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    <p>NBAæ•°æ®çˆ¬å–ä¸å±•ç¤ºç³»ç»Ÿ &copy; 2025 | åŸºäºFlask + BeautifulSoupæ„å»º</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- è‡ªå®šä¹‰JavaScript -->
    <script>
        // DOMå…ƒç´ 
        const extractBtn = document.getElementById('extractBtn');
        const showBtn = document.getElementById('showBtn');
        const exportBtn = document.getElementById('exportBtn');
        const refreshTopBtn = document.getElementById('refreshTopBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        const messageArea = document.getElementById('messageArea');
        const dataTableBody = document.getElementById('dataTableBody');
        const noDataRow = document.getElementById('noDataRow');
        const dataCount = document.getElementById('dataCount');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const backendStatus = document.getElementById('backendStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        
        // æœ€é«˜çƒå‘˜æ•°æ®å…ƒç´ 
        const topScorerName = document.getElementById('topScorerName');
        const topScorerScore = document.getElementById('topScorerScore');
        const topRebounderName = document.getElementById('topRebounderName');
        const topRebounderRebounds = document.getElementById('topRebounderRebounds');
        const topAssisterName = document.getElementById('topAssisterName');
        const topAssisterAssists = document.getElementById('topAssisterAssists');
        const topPlayersDate = document.getElementById('topPlayersDate');
        
        // å®šæ—¶ä»»åŠ¡ç®¡ç†å…ƒç´ 
        const triggerCrawlBtn = document.getElementById('triggerCrawlBtn');
        const refreshSchedulerBtn = document.getElementById('refreshSchedulerBtn');
        const startSchedulerBtn = document.getElementById('startSchedulerBtn');
        const stopSchedulerBtn = document.getElementById('stopSchedulerBtn');
        const viewLogsBtn = document.getElementById('viewLogsBtn');
        const schedulerStatus = document.getElementById('schedulerStatus');
        const lastCrawlTime = document.getElementById('lastCrawlTime');
        const schedulerJobs = document.getElementById('schedulerJobs');
        
        // APIç«¯ç‚¹
        const API_BASE = window.location.origin;
        const EXTRACT_API = `${API_BASE}/extract_data`;
        const SHOW_API = `${API_BASE}/show_data`;
        const EXPORT_API = `${API_BASE}/static/NBA.xlsx`;  // ç›´æ¥ä½¿ç”¨é™æ€æ–‡ä»¶è·¯å¾„
        const TOP_PLAYERS_API = `${API_BASE}/top_players`;
        const SCHEDULER_STATUS_API = `${API_BASE}/scheduler/status`;
        const SCHEDULER_TRIGGER_API = `${API_BASE}/scheduler/trigger`;
        const SCHEDULER_START_API = `${API_BASE}/scheduler/start`;
        const SCHEDULER_STOP_API = `${API_BASE}/scheduler/stop`;
        
        // çŠ¶æ€ç®¡ç†
        let isProcessing = false;
        let lastUpdateTime = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendStatus();
            updateLastUpdateTime();
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬
            extractBtn.addEventListener('click', extractData);
            showBtn.addEventListener('click', showData);
            exportBtn.addEventListener('click', exportData);
            refreshTopBtn.addEventListener('click', loadTopPlayers);
            
            // æ·»åŠ å®šæ—¶ä»»åŠ¡æŒ‰é’®äº‹ä»¶ç›‘å¬
            if (triggerCrawlBtn) triggerCrawlBtn.addEventListener('click', triggerCrawlManually);
            if (refreshSchedulerBtn) refreshSchedulerBtn.addEventListener('click', loadSchedulerStatus);
            if (startSchedulerBtn) startSchedulerBtn.addEventListener('click', startScheduler);
            if (stopSchedulerBtn) stopSchedulerBtn.addEventListener('click', stopScheduler);
            if (viewLogsBtn) viewLogsBtn.addEventListener('click', viewLogs);
            
            // åŠ è½½æœ€é«˜çƒå‘˜æ•°æ®
            loadTopPlayers();
            
            // åŠ è½½å®šæ—¶ä»»åŠ¡çŠ¶æ€
            loadSchedulerStatus();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°å®šæ—¶ä»»åŠ¡çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
            setInterval(loadSchedulerStatus, 30000);
        });
        
        // æ£€æŸ¥åç«¯çŠ¶æ€
        async function checkBackendStatus() {
            try {
                const response = await fetch(SHOW_API, { method: 'HEAD' });
                if (response.ok) {
                    backendStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>è¿è¡Œæ­£å¸¸</span>';
                } else {
                    backendStatus.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>è¿æ¥å¼‚å¸¸</span>';
                }
            } catch (error) {
                backendStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>æ— æ³•è¿æ¥</span>';
            }
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            if (lastUpdateTime) {
                const timeStr = new Date(lastUpdateTime).toLocaleString('zh-CN');
                lastUpdate.textContent = timeStr;
            } else {
                lastUpdate.textContent = 'ä»æœªæ›´æ–°';
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(type, text) {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            const messageHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${icon} me-2"></i>${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            messageArea.innerHTML = messageHtml;
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        if (alert.parentNode === messageArea) {
                            messageArea.removeChild(alert);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(isLoading, text = 'æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œè¯·ç¨å€™...') {
            isProcessing = isLoading;
            
            if (isLoading) {
                loadingSpinner.style.display = 'block';
                loadingText.textContent = text;
                extractBtn.disabled = true;
                showBtn.disabled = true;
                statusIndicator.className = 'status-indicator status-loading';
                statusText.textContent = 'å¤„ç†ä¸­...';
            } else {
                loadingSpinner.style.display = 'none';
                extractBtn.disabled = false;
                showBtn.disabled = false;
                statusIndicator.className = 'status-indicator status-ready';
                statusText.textContent = 'å°±ç»ª';
            }
        }
        
        // æå–æ•°æ®
        async function extractData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨çˆ¬å–NBAæ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...');
            
            try {
                const response = await fetch(EXTRACT_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', 'æ•°æ®çˆ¬å–æˆåŠŸï¼æ•°æ®å·²ä¿å­˜åˆ°Excelæ–‡ä»¶ã€‚æ­£åœ¨è‡ªåŠ¨åŠ è½½æ•°æ®...');
                    lastUpdateTime = new Date();
                    updateLastUpdateTime();
                    
                    // çˆ¬å–æˆåŠŸåè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®å’Œæœ€é«˜çƒå‘˜æ•°æ®
                    setTimeout(() => {
                        showData();
                        loadTopPlayers();
                    }, 1000);
                } else {
                    showMessage('error', `æ•°æ®çˆ¬å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æå–æ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
                checkBackendStatus();
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®
        async function showData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨åŠ è½½NBAæ•°æ®...');
            
            try {
                const response = await fetch(SHOW_API);
                const data = await response.json();
                
                if (response.ok) {
                    displayData(data.NBA_datas || []);
                    showMessage('success', `æˆåŠŸåŠ è½½ ${data.NBA_datas ? data.NBA_datas.length : 0} æ¡æ•°æ®`);
                } else {
                    showMessage('error', `åŠ è½½æ•°æ®å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºæ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨å‡†å¤‡Excelæ–‡ä»¶ä¸‹è½½...');
            
            try {
                // åˆ›å»ºä¸€ä¸ªéšè—çš„é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶
                const link = document.createElement('a');
                link.href = `${API_BASE}/static/NBA.xlsx`;
                link.download = `NBAæ•°æ®_${new Date().toISOString().slice(0,10)}.xlsx`;
                link.target = '_blank';
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('success', 'Excelæ–‡ä»¶ä¸‹è½½å·²å¼€å§‹');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `å¯¼å‡ºå¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®åˆ°è¡¨æ ¼
        function displayData(data) {
            // æ¸…é™¤ç°æœ‰æ•°æ®
            dataTableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                dataTableBody.innerHTML = `
                    <tr id="noDataRow">
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="fas fa-database fa-3x mb-3"></i>
                            <p>æš‚æ— æ•°æ®</p>
                        </td>
                    </tr>
                `;
                dataCount.textContent = '0 æ¡æ•°æ®';
                return;
            }
            
            // ç§»é™¤æ— æ•°æ®è¡Œ
            if (noDataRow) {
                noDataRow.remove();
            }
            
            let rowCount = 0;
            
            // å¤„ç†æ•°æ®è¡Œ
            data.forEach((row, rowIndex) => {
                // è·³è¿‡è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰
                if (rowIndex === 0) return;
                
                // å¤„ç†æ¯ä¸€è¡Œçš„æ•°æ®
                // æ•°æ®æ ¼å¼: [ç±»å‹, æ’å, å§“å, æ•°æ®, ç©º, ç±»å‹, æ’å, å§“å, æ•°æ®, ç©º, ç±»å‹, æ’å, å§“å, æ•°æ®]
                // æ¯è¡ŒåŒ…å«3ç»„æ•°æ®ï¼ˆå¾—åˆ†ã€ç¯®æ¿ã€åŠ©æ”»ï¼‰
                
                // åˆ›å»ºä¸‰è¡Œæ•°æ®ï¼Œæ¯ç»„æ•°æ®ä¸€è¡Œ
                for (let groupIndex = 0; groupIndex < 3; groupIndex++) {
                    const dataStart = groupIndex * 5; // æ¯ç»„æ•°æ®å 5åˆ—ï¼ˆç±»å‹,æ’å,å§“å,æ•°æ®,ç©ºï¼‰
                    const dataType = row[dataStart];
                    const rank = row[dataStart + 1];
                    const name = row[dataStart + 2];
                    const value = row[dataStart + 3];
                    
                    // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡
                    if (!dataType || !rank || !name || !value) continue;
                    
                    rowCount++;
                    
                    // æ ¹æ®æ•°æ®ç±»å‹è®¾ç½®æ ·å¼
                    let badgeClass = 'badge-category';
                    let dataTypeText = dataType;
                    
                    if (dataType === 'å¾—åˆ†') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#e74c3c">ğŸ€ å¾—åˆ†</span>';
                    } else if (dataType === 'ç¯®æ¿') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#3498db">ğŸ“Š ç¯®æ¿</span>';
                    } else if (dataType === 'åŠ©æ”»') {
                        badgeClass = 'badge-category';
                        dataTypeText = '<span style="color:#2ecc71">ğŸ¤ åŠ©æ”»</span>';
                    }
                    
                    // åˆ›å»ºè¡¨æ ¼è¡Œ
                    const rowHtml = `
                        <tr>
                            <td>${rowCount}</td>
                            <td>${dataTypeText}</td>
                            <td>
                                <span class="badge bg-primary rounded-pill">${rank}</span>
                            </td>
                            <td>
                                <strong>${name}</strong>
                            </td>
                            <td>
                                <span class="badge bg-success rounded-pill fs-6">${value}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewPlayerDetails('${name}', '${dataType}', '${value}')">
                                    <i class="fas fa-search"></i> è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    dataTableBody.innerHTML += rowHtml;
                }
            });
            
            // æ›´æ–°æ•°æ®è®¡æ•°
            dataCount.textContent = `${rowCount} æ¡æ•°æ®`;
        }
        
        // æŸ¥çœ‹çƒå‘˜è¯¦æƒ…
        function viewPlayerDetails(name, dataType, value) {
            alert(`çƒå‘˜è¯¦æƒ…:\n\nå§“å: ${name}\næ•°æ®ç±»å‹: ${dataType}\næ•°å€¼: ${value}`);
        }
        
        // åŠ è½½æœ€é«˜çƒå‘˜æ•°æ®
        async function loadTopPlayers() {
            try {
                const response = await fetch(TOP_PLAYERS_API);
                const data = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°å¾—åˆ†ç‹
                    topScorerName.textContent = data.top_scorer?.name || 'æš‚æ— æ•°æ®';
                    topScorerScore.textContent = data.top_scorer?.score || '0';
                    
                    // æ›´æ–°ç¯®æ¿ç‹
                    topRebounderName.textContent = data.top_rebounder?.name || 'æš‚æ— æ•°æ®';
                    topRebounderRebounds.textContent = data.top_rebounder?.rebounds || '0';
                    
                    // æ›´æ–°åŠ©æ”»ç‹
                    topAssisterName.textContent = data.top_assister?.name || 'æš‚æ— æ•°æ®';
                    topAssisterAssists.textContent = data.top_assister?.assists || '0';
                    
                    // æ›´æ–°æ—¥æœŸ
                    topPlayersDate.textContent = `æ•°æ®æ—¥æœŸ: ${data.date || '--'}`;
                    
                    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    animateTopPlayers();
                } else {
                    showMessage('error', `åŠ è½½æœ€é«˜çƒå‘˜æ•°æ®å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åŠ è½½æœ€é«˜çƒå‘˜æ•°æ®æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        function animateTopPlayers() {
            const elements = [
                topScorerName, topScorerScore,
                topRebounderName, topRebounderRebounds,
                topAssisterName, topAssisterAssists
            ];
            
            elements.forEach(element => {
                if (element) {
                    element.style.transform = 'scale(1.1)';
                    element.style.transition = 'transform 0.3s ease';
                    
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 300);
                }
            });
        }
        
        // å®šæ—¶ä»»åŠ¡ç›¸å…³åŠŸèƒ½
        
        // åŠ è½½å®šæ—¶ä»»åŠ¡çŠ¶æ€
        async function loadSchedulerStatus() {
            try {
                const response = await fetch(SCHEDULER_STATUS_API);
                const data = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°çŠ¶æ€æ ‡ç­¾ - å¤„ç†å¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²
                    if (schedulerStatus) {
                        const isRunning = data.scheduler_running === true || data.status === 'running';
                        if (isRunning) {
                            schedulerStatus.className = 'badge bg-success';
                            schedulerStatus.textContent = 'è¿è¡Œä¸­';
                        } else {
                            schedulerStatus.className = 'badge bg-danger';
                            schedulerStatus.textContent = 'å·²åœæ­¢';
                        }
                    }
                    
                    // æ›´æ–°æœ€åçˆ¬å–æ—¶é—´ - æ”¯æŒå¤šä¸ªå¯èƒ½çš„å­—æ®µå
                    if (lastCrawlTime) {
                        const crawlTime = data.last_crawl_time || data.timestamp;
                        if (crawlTime) {
                            try {
                                const timeStr = new Date(crawlTime).toLocaleString('zh-CN');
                                lastCrawlTime.textContent = `æœ€åçˆ¬å–: ${timeStr}`;
                            } catch (e) {
                                lastCrawlTime.textContent = `æœ€åçˆ¬å–: ${crawlTime}`;
                            }
                        } else {
                            lastCrawlTime.textContent = 'æœ€åçˆ¬å–: ä»æœªçˆ¬å–';
                        }
                    }
                    
                    // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
                    if (schedulerJobs) {
                        schedulerJobs.innerHTML = '';
                        
                        if (data.jobs && data.jobs.length > 0) {
                            data.jobs.forEach(job => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                                
                                // æ ¼å¼åŒ–ä¸‹æ¬¡è¿è¡Œæ—¶é—´
                                let nextRunTime = 'æœªå®‰æ’';
                                if (job.next_run_time) {
                                    try {
                                        nextRunTime = new Date(job.next_run_time).toLocaleString('zh-CN');
                                    } catch (e) {
                                        nextRunTime = job.next_run_time;
                                    }
                                }
                                
                                const jobInfo = document.createElement('div');
                                jobInfo.innerHTML = `
                                    <strong>${job.name || job.id}</strong><br>
                                    <small class="text-muted">${nextRunTime}</small>
                                `;
                                
                                const statusBadge = document.createElement('span');
                                // ä½¿ç”¨job.runningå­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸ºfalse
                                const isJobRunning = job.running === true;
                                statusBadge.className = isJobRunning ? 'badge bg-warning' : 'badge bg-info';
                                statusBadge.textContent = isJobRunning ? 'æ‰§è¡Œä¸­' : 'ç­‰å¾…ä¸­';
                                
                                li.appendChild(jobInfo);
                                li.appendChild(statusBadge);
                                schedulerJobs.appendChild(li);
                            });
                        } else {
                            const li = document.createElement('li');
                            li.className = 'list-group-item text-muted text-center';
                            li.textContent = 'æš‚æ— å®šæ—¶ä»»åŠ¡';
                            schedulerJobs.appendChild(li);
                        }
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (startSchedulerBtn && stopSchedulerBtn) {
                        const isRunning = data.scheduler_running === true || data.status === 'running';
                        startSchedulerBtn.disabled = isRunning;
                        stopSchedulerBtn.disabled = !isRunning;
                    }
                } else {
                    console.error('è·å–å®šæ—¶ä»»åŠ¡çŠ¶æ€å¤±è´¥:', data.error);
                    showMessage('error', `è·å–å®šæ—¶ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åŠ è½½å®šæ—¶ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™:', error);
                if (schedulerStatus) {
                    schedulerStatus.className = 'badge bg-warning';
                    schedulerStatus.textContent = 'è¿æ¥å¤±è´¥';
                }
                showMessage('error', `åŠ è½½å®šæ—¶ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ‰‹åŠ¨è§¦å‘çˆ¬å–
        async function triggerCrawlManually() {
            if (isProcessing) return;
            
            setLoading(true, 'æ­£åœ¨æ‰‹åŠ¨çˆ¬å–æ•°æ®...');
            
            try {
                const response = await fetch(SCHEDULER_TRIGGER_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', 'æ‰‹åŠ¨çˆ¬å–å·²è§¦å‘ï¼æ­£åœ¨æ‰§è¡Œæ•°æ®çˆ¬å–...');
                    
                    // ç­‰å¾…å‡ ç§’ååˆ·æ–°çŠ¶æ€å’Œæ•°æ®
                    setTimeout(() => {
                        loadSchedulerStatus();
                        showData();
                        loadTopPlayers();
                    }, 3000);
                } else {
                    showMessage('error', `æ‰‹åŠ¨çˆ¬å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨è§¦å‘çˆ¬å–æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // å¯åŠ¨å®šæ—¶æœåŠ¡
        async function startScheduler() {
            try {
                const response = await fetch(SCHEDULER_START_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', 'å®šæ—¶æœåŠ¡å·²å¯åŠ¨ï¼ç³»ç»Ÿå°†åœ¨æ¯å¤©ä¸Šåˆ9ç‚¹è‡ªåŠ¨çˆ¬å–æ•°æ®ã€‚');
                    loadSchedulerStatus();
                } else {
                    showMessage('error', `å¯åŠ¨å®šæ—¶æœåŠ¡å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å¯åŠ¨å®šæ—¶æœåŠ¡æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // åœæ­¢å®šæ—¶æœåŠ¡
        async function stopScheduler() {
            try {
                const response = await fetch(SCHEDULER_STOP_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('warning', 'å®šæ—¶æœåŠ¡å·²åœæ­¢ï¼ç³»ç»Ÿå°†ä¸å†è‡ªåŠ¨çˆ¬å–æ•°æ®ã€‚');
                    loadSchedulerStatus();
                } else {
                    showMessage('error', `åœæ­¢å®šæ—¶æœåŠ¡å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åœæ­¢å®šæ—¶æœåŠ¡æ—¶å‡ºé”™:', error);
                showMessage('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // æŸ¥çœ‹æ—¥å¿—
        function viewLogs() {
            alert('æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...\n\nå½“å‰æ—¥å¿—æ–‡ä»¶ä½ç½®:\n- Flaskæ—¥å¿—: bs_opxl_/flask_server.log\n- çˆ¬å–æ—¥å¿—: bs_opxl_/scheduler_dir/crawl.log');
        }
        
        // æ£€æŸ¥åç«¯è¿æ¥
        checkBackendStatus();
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        updateLastUpdateTime();
    </script>
</body>
</html>